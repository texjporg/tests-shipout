%%% candidate 3: mostly compatible
\ExplSyntaxOn
\cs_new_eq:NN \__platex_original_shipout_execute_cont: \__shipout_execute_cont:
\box_new:N \l__platex_shipout_dummy_box
\cs_set:Npn \__shipout_execute_cont:
  {
    % >>> \l_shipout_box が横組でない場合は事前に横組化する
    % if \l_shipout_box is not a \yoko-box (= horizontal writing),
    % then make it a \yoko-box behorehand.
    \tex_ifybox:D \l_shipout_box
    \else:
      \vbox_set:Nn \l_shipout_box
        {
            \tex_yoko:D
            \box_use:N \l_shipout_box
        }
    \fi:
    % >>> 横組でない場合は \__shipout_execute_cont: を
    % >>> 横組ボックス \l__platex_shipout_dummy_box で括って実行する
    % if the current direction is not \yoko,
    % then enclose \__shipout_execute_cont: with
    % a dummy \yoko-box named \l__platex_shipout_dummy_box.
    \tex_ifydir:D
      \__platex_original_shipout_execute_cont:
    \else:
      \vbox_set:Nn \l__platex_shipout_dummy_box
        {
          \tex_yoko:D
          \__platex_original_shipout_execute_cont:
        }
      %% >>> 制限事項：処理終了時に \box\l__platex_shipout_dummy_box して
      %% >>> メイン垂直リストに中身を戻したいが，無限ループするので不可。
      %% [Limitation] the code above may discard some contents,
      %% so we'd like to put it back by \box\l__platex_shipout_dummy_box.
      %% however, an infinite loop occurs if we uncomment the line below
      %% so we can't.
      %\box_use:N \l__platex_shipout_dummy_box
    \fi:
  }
\ExplSyntaxOff
%%%
